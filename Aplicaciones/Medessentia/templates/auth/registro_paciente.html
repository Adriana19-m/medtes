{% extends "public/base_public.html" %}
{% load static %}
{% block title %}Registro Paciente{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 640px;">
  <h2 class="text-center mb-3">Crear cuenta de Paciente</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mt-2">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="post" id="formRegistroPaciente"
        class="card p-4 shadow-sm needs-validation" novalidate>
    {% csrf_token %}

    <!-- Usuario / Correo -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Usuario</label>
        <input name="username" class="form-control" required
               value="{{ prefill.username|default:'' }}">
        <div class="invalid-feedback">El usuario es obligatorio.</div>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Correo</label>
        <input type="email" name="email" class="form-control" required
               value="{{ prefill.email|default:'' }}">
        <div class="invalid-feedback">Ingresa un correo válido.</div>
      </div>
    </div>

    <!-- Nombre / Apellido -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Nombre</label>
        <input name="first_name" class="form-control" required
               value="{{ prefill.first_name|default:'' }}">
        <div class="invalid-feedback">El nombre es obligatorio.</div>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Apellido</label>
        <input name="last_name" class="form-control" required
               value="{{ prefill.last_name|default:'' }}">
        <div class="invalid-feedback">El apellido es obligatorio.</div>
      </div>
    </div>

    <!-- ===== CONTRASEÑAS ===== -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Contraseña</label>
        <div class="input-group">
          <input type="password" name="password1" id="password1"
                 class="form-control" minlength="8" required>
          <button type="button" class="btn btn-outline-secondary"
                  onclick="togglePassword('password1', this)">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <div class="invalid-feedback">
          La contraseña debe tener al menos 8 caracteres.
        </div>
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Confirmar contraseña</label>
        <div class="input-group">
          <input type="password" name="password2" id="password2"
                 class="form-control" minlength="8" required>
          <button type="button" class="btn btn-outline-secondary"
                  onclick="togglePassword('password2', this)">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <div class="invalid-feedback">
          Las contraseñas no coinciden o no cumplen el mínimo.
        </div>
      </div>
    </div>

    <hr class="my-3">

    <h5 class="mb-3">Datos de perfil</h5>

    <!-- Cédula / Teléfono -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Cédula (10 dígitos)</label>
        <input name="cedula_usuario" id="cedula_usuario"
               maxlength="10" minlength="10"
               class="form-control" required
               pattern="^[0-9]{10}$"
               value="{{ prefill.cedula_usuario|default:'' }}">
        <div class="invalid-feedback">
          Debe ingresar una cédula válida de 10 dígitos.
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Teléfono (10 dígitos)</label>
        <input name="telefono_usuario" id="telefono_usuario"
               maxlength="10" minlength="10"
               class="form-control" required
               pattern="^[0-9]{10}$"
               value="{{ prefill.telefono_usuario|default:'' }}">
        <div class="invalid-feedback">
          Debe ingresar un número válido de 10 dígitos.
        </div>
      </div>
    </div>

    <!-- Dirección -->
    <div class="mb-3">
      <label class="form-label">Dirección</label>
      <input name="direccion_usuario" class="form-control" required
             value="{{ prefill.direccion_usuario|default:'' }}">
      <div class="invalid-feedback">La dirección es obligatoria.</div>
    </div>

    <!-- Género -->
    <div class="mb-3">
      <label class="form-label">Género</label>
      <select name="genero_usuario" class="form-select" required>
        <option value="">-- Selecciona --</option>
        <option value="Masculino" {% if prefill.genero_usuario == "Masculino" %}selected{% endif %}>Masculino</option>
        <option value="Femenino" {% if prefill.genero_usuario == "Femenino" %}selected{% endif %}>Femenino</option>
        <option value="Otro" {% if prefill.genero_usuario == "Otro" %}selected{% endif %}>Otro</option>
      </select>
      <div class="invalid-feedback">Selecciona una opción.</div>
    </div>

    <button class="btn btn-success w-100 mt-3">Crear cuenta</button>
  </form>

  <div class="text-center mt-3">
    <a href="{% url 'login' %}">¿Ya tienes cuenta? Inicia sesión</a>
  </div>
</div>

<!-- ======= JavaScript ======= -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("formRegistroPaciente");
  const pass1 = document.getElementById("password1");
  const pass2 = document.getElementById("password2");

  function validarPasswords() {
    if (pass1.value !== pass2.value) {
      pass2.setCustomValidity("Las contraseñas no coinciden");
    } else {
      pass2.setCustomValidity("");
    }
  }

  pass1.addEventListener("input", validarPasswords);
  pass2.addEventListener("input", validarPasswords);

  form.addEventListener("submit", function (event) {
    validarPasswords();

    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    }

    form.classList.add("was-validated");
  });
});

function togglePassword(inputId, btn) {
  const input = document.getElementById(inputId);
  const icon = btn.querySelector("i");

  if (input.type === "password") {
    input.type = "text";
    icon.classList.replace("bi-eye", "bi-eye-slash");
  } else {
    input.type = "password";
    icon.classList.replace("bi-eye-slash", "bi-eye");
  }
}
</script>
{% endblock %}
