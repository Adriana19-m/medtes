{% extends "public/base_paciente.html" %}
{% load static %}
{% block title %}Horarios del Doctor{% endblock %}
{% block paciente_content %}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body {
    background-color: #f5f9f7;
  }
  h2 {
    color: #155d4d;
    font-weight: 700;
  }
  #calendar {
    background: #fff;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    min-height: 750px;
  }
  .fc-toolbar-title {
    color: #155d4d !important;
    font-weight: bold;
  }
  .fc-button {
    background-color: #2aa574 !important;
    border: none !important;
  }
  .fc-button:hover {
    background-color: #238c62 !important;
  }
  .modal-header {
    background-color: #2aa574 !important;
  }
  .fc-event {
    cursor: pointer;
    font-weight: bold;
  }

  #debugInfo { display: none !important; }
</style>

<div class="container py-4">
  <h2 class="mb-4">Horarios de <strong>{{ doctor.get_full_name|default:doctor.username }}</strong></h2>
  <div id="calendar"></div>
</div>


<div class="modal fade" id="modalAgendar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formAgendar" class="modal-content">
      <div class="modal-header text-white" style="background-color: #2aa574;">
        <h5 class="modal-title">Confirmar cita</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="horario_id">
        <p><strong>Doctor:</strong> {{ doctor.get_full_name|default:doctor.username }}</p>
        <p><strong>Fecha:</strong> <span id="modal_fecha"></span></p>

        <div class="mb-3">
          <label for="hora_cita" class="form-label"><strong>Seleccione hora</strong></label>
          <select id="hora_cita" class="form-select" required></select>
        </div>

        <div class="mb-3">
          <label for="motivo" class="form-label">Motivo (opcional)</label>
          <textarea class="form-control" id="motivo" rows="3"></textarea>
        </div>

        <div id="alertArea"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success" id="btnConfirmar">Agendar cita</button>
      </div>
    </form>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const doctorId = {{ doctor.id }};
  const eventosUrl = `/cita/doctor/${doctorId}/horarios/`;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    locale: 'es',
    buttonText: {
      today: 'Hoy',
      week: 'Semana',
      day: 'Día',
      list: 'Lista'
    },
    initialView: 'timeGridWeek',
    validRange: function(nowDate) {
      return {
        start: nowDate
      };
    },
    height: 'auto',
    nowIndicator: true,
    allDaySlot: false,
    expandRows: true,
    slotMinTime: '07:00:00',
    slotMaxTime: '22:00:00',
    slotDuration: '00:30:00',
    timeZone: 'local',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'timeGridWeek,timeGridDay'
    },
    

    events: function(fetchInfo, successCallback, failureCallback) {
      const url = `${eventosUrl}?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`;

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
          return response.json();
        })
        .then(data => {
          successCallback(data); // FullCalendar ya entiende ISO
        })
        .catch(error => {
          console.error('Error al cargar eventos:', error);
          failureCallback(error);
        });
    },

  
    eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },

    eventClick: function(info) {
      const props = info.event.extendedProps || {};

     
      if (props.disponible === false) {
        Swal.fire({
          icon: 'warning',
          title: 'Horario no disponible',
          text: 'Este bloque ya ha sido ocupado por otro paciente.',
          confirmButtonColor: '#3085d6'
        });
        return;
      }

      
      const modal = new bootstrap.Modal(document.getElementById('modalAgendar'));
      const selectHora = document.getElementById('hora_cita');
      selectHora.innerHTML = '';

      const [h1, m1] = props.hora_inicio.split(':').map(Number);
      const [h2, m2] = props.hora_fin.split(':').map(Number);
      const start = new Date(0, 0, 0, h1, m1);
      const end = new Date(0, 0, 0, h2, m2);

      for (let t = new Date(start); t < end; t.setMinutes(t.getMinutes() + 30)) {
        const horaStr = t.toTimeString().slice(0, 5);
        const option = document.createElement('option');
        option.value = horaStr;
        option.textContent = horaStr;
        selectHora.appendChild(option);
      }

      document.getElementById('horario_id').value = info.event.id;
      document.getElementById('modal_fecha').innerText =
        info.event.start.toLocaleDateString('es-ES');

      modal.show();
    }
  });

  calendar.render();

 
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const form = document.getElementById('formAgendar');
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const horario_id = document.getElementById('horario_id').value;
    const motivo = document.getElementById('motivo').value;
    const hora_cita = document.getElementById('hora_cita').value;

    const url = `/cita/doctor/${doctorId}/agendar/`;
    const formData = new FormData();
    formData.append('horario_id', horario_id);
    formData.append('motivo', motivo);
    formData.append('hora_cita', hora_cita);

    const btn = document.getElementById('btnConfirmar');
    btn.disabled = true;
    btn.innerText = 'Agendando...';

    fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: formData,
    })
    .then(async res => {
      btn.disabled = false;
      btn.innerText = 'Agendar cita';
      const data = await res.json().catch(()=>({message:'Error desconocido del servidor'}));
      if (!res.ok) {
        Swal.fire('Error', data.message || 'No se pudo agendar la cita.', 'error');
        throw new Error(data.message || 'Error');
      }
      return data;
    })
    .then(data => {
      if (data.status === 'success') {
        bootstrap.Modal.getInstance(document.getElementById('modalAgendar')).hide();
        Swal.fire('✅ Éxito', data.message, 'success');
        calendar.refetchEvents();
      } else {
        Swal.fire('⚠️ Atención', data.message, 'warning');
      }
    })
    .catch(err => {
      Swal.fire('Error', err.message, 'error');
    });
  });
});
</script>

{% endblock %}
