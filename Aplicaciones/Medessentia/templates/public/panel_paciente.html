{% extends "public/base_paciente.html" %}
{% block title %}Panel del Paciente - Medessentia{% endblock %}

{% block extra_css %}
<style>
  /* Tus estilos CSS originales se mantienen igual */
  .card {
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
  .card-header {
    background-color: #ffffff;
    border-bottom: 1px solid #e9ecef;
    padding: 15px 20px;
  }
  
  .card-body {
    padding: 20px;
  }
  
  .card.border-start {
    border-left-width: 4px !important;
  }
  
  .card.border-primary .card-body h3,
  .card.border-success .card-body h3,
  .card.border-info .card-body h3 {
    font-size: 2rem;
    font-weight: 600;
    margin: 5px 0 0 0;
  }
  
  /* ... resto de tus estilos CSS ... */
</style>
{% endblock %}

{% block paciente_content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12 px-4 pt-3 pb-4">

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div class="mb-3 mb-md-0">
          <h2 class="mb-1">
            <i class="fas fa-tachometer-alt text-primary me-2"></i>
            Panel de Paciente
          </h2>
          <p class="text-muted mb-0">Bienvenido, {{ user.first_name|default:user.username }}</p>
        </div>
        <a href="{% url 'cita_elegir_doctor' %}" class="btn btn-primary btn-sm">
          <i class="fas fa-calendar-plus me-1"></i>Nueva Cita
        </a>
      </div>

      <div class="row g-4 mb-4">
        <!-- Tarjeta de Signos Vitales - MODIFICADA -->
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="card border-start border-success border-4 h-100">
            <div class="card-body">
              <h6 class="text-muted">Signos Vitales Registrados</h6>
              <h3 class="mt-2">{{ signos.count }}</h3>
              {% if signos %}
                {% with ultimo_signo=signos.last %}
                  <small class="text-muted d-block mt-2">
                    <i class="fas fa-history me-1"></i>
                    Último registro: {{ ultimo_signo.fecha_registro|date:"d/m/Y" }}
                  </small>
                {% endwith %}
              {% else %}
                <small class="text-muted d-block mt-2">Sin registros aún</small>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Otras tarjetas se mantienen igual -->
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="card border-start border-primary border-4 h-100">
            <div class="card-body">
              <h6 class="text-muted">Citas Pendientes</h6>
              <h3 class="mt-2">0</h3>
              <small class="text-muted d-block mt-2">No hay citas pendientes</small>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-4">
          <div class="card border-start border-info border-4 h-100">
            <div class="card-body">
              <h6 class="text-muted">Mi Doctor</h6>
              <h5 class="mt-2">{{ perfil.doctor_asignado|default:"Dr. Alexandra Toapanta" }}</h5>
              <small class="text-muted d-block mt-2">Médico General</small>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-12 col-lg-8">
          <div class="card h-100">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="fas fa-user-circle text-primary me-2"></i>
                Mi Información Personal
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-12 col-md-6 mb-3">
                  <p class="mb-1"><strong>Cédula:</strong></p>
                  <p class="text-muted">{{ perfil.cedula_usuario|default:"No registrada" }}</p>
                </div>
                <div class="col-12 col-md-6 mb-3">
                  <p class="mb-1"><strong>Teléfono:</strong></p>
                  <p class="text-muted">{{ perfil.telefono_usuario|default:"No registrado" }}</p>
                </div>
                <div class="col-12 mb-3">
                  <p class="mb-1"><strong>Dirección:</strong></p>
                  <p class="text-muted">{{ perfil.direccion_usuario|default:"No registrada" }}</p>
                </div>
              </div>
              <a href="{% url 'mi_perfil' %}" class="btn btn-outline-primary mt-2">
                <i class="fas fa-edit me-1"></i>Ver información completa
              </a>
            </div>
          </div>
        </div>

        <!-- SECCIÓN MODIFICADA - ÚLTIMO SIGNO VITAL -->
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="fas fa-heartbeat text-success me-2"></i>
                Último Signo Vital Registrado
              </h5>
            </div>
            <div class="card-body">
              {% if signos %}
                <!-- SOLUCIÓN: Usar .last para obtener el último registro -->
                {% with ultimo_signo=signos.last %}
                  <div class="alert alert-info alert-sm mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    <small>Registro más reciente del paciente</small>
                  </div>
                  
                  <div class="row">
                    <div class="col-6 mb-2">
                      <p class="mb-0 small"><strong>Presión:</strong></p>
                      <p class="text-muted small">{{ ultimo_signo.presion_arterial|default:"---" }}</p>
                    </div>
                    <div class="col-6 mb-2">
                      <p class="mb-0 small"><strong>Cardíaca:</strong></p>
                      <p class="text-muted small">{{ ultimo_signo.frecuencia_cardiaca|default:"---" }} bpm</p>
                    </div>
                    <div class="col-6 mb-2">
                      <p class="mb-0 small"><strong>Temperatura:</strong></p>
                      <p class="text-muted small">{{ ultimo_signo.temperatura|default:"---" }}°C</p>
                    </div>
                    <div class="col-6 mb-2">
                      <p class="mb-0 small"><strong>Oxígeno:</strong></p>
                      <p class="text-muted small">{{ ultimo_signo.oxigeno_sangre|default:"---" }}%</p>
                    </div>
                  </div>
                  
                  <div class="mt-3 pt-2 border-top">
                    <small class="text-muted d-block">
                      <i class="fas fa-calendar me-1"></i>
                      Fecha: {{ ultimo_signo.fecha_registro|date:"d/m/Y" }}
                    </small>
                    <small class="text-muted d-block mt-1">
                      <i class="fas fa-clock me-1"></i>
                      Hora: {{ ultimo_signo.fecha_registro|time:"H:i" }}
                    </small>
                  </div>
                  
                  <!-- Botón para ver todos los signos -->
                  <div class="mt-3">
                    <a href="#" class="btn btn-sm btn-outline-success w-100">
                      <i class="fas fa-list me-1"></i>Ver historial completo
                    </a>
                  </div>
                {% endwith %}
              {% else %}
                <div class="text-center py-4">
                  <i class="fas fa-heartbeat fa-3x text-muted mb-3"></i>
                  <p class="text-muted mb-2">No hay registros de signos vitales</p>
                  <small class="text-muted d-block mb-3">Contacta a tu médico para registrar tus signos</small>
                  <a href="#" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-stethoscope me-1"></i>Solicitar medición
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Eliminamos la tabla de citas pendientes temporalmente -->
      <!-- {% if citas_pendientes %} ... {% endif %} -->

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function adjustCardHeights() {
    if (window.innerWidth >= 768) {
      const cards = document.querySelectorAll('.card.h-100');
      cards.forEach(card => {
        card.style.minHeight = '200px';
      });
    } else {
      const cards = document.querySelectorAll('.card.h-100');
      cards.forEach(card => {
        card.style.minHeight = '';
      });
    }
  }
  
  adjustCardHeights();
  window.addEventListener('resize', adjustCardHeights);
});
</script>
{% endblock %}