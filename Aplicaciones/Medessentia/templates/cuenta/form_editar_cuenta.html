<h2 class="mb-3">Editar mi cuenta</h2>

<form id="editarCuentaForm" method="post" class="card p-3" onsubmit="return validarEdicion();">
  {% csrf_token %}

  <div class="mb-2">
    <label class="form-label">Nombres</label>
    <input id="first_name" name="first_name" class="form-control"
           value="{{ user.first_name }}" required>
  </div>

  <div class="mb-2">
    <label class="form-label">Apellidos</label>
    <input id="last_name" name="last_name" class="form-control"
           value="{{ user.last_name }}" required>
  </div>

  <div class="mb-2">
    <label class="form-label">Correo electrónico</label>
    <input id="email" name="email" type="email" class="form-control"
           value="{{ user.email }}" required>
  </div>

  <button type="submit" class="btn btn-primary mt-3">
    Guardar cambios
  </button>
</form>

<a href="{% url 'redirigir_segun_rol' %}" class="btn btn-outline-secondary mt-3">
  ← Volver
</a>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function validarEdicion() {
  let valido = true;
  let errores = [];

  const campos = [
    { id: 'first_name', nombre: 'Nombre' },
    { id: 'last_name', nombre: 'Apellido' },
    { id: 'email', nombre: 'Correo electrónico' }
  ];

  // Limpiar errores previos
  campos.forEach(c => {
    document.getElementById(c.id).classList.remove('is-invalid');
  });

  // Validar campos vacíos
  campos.forEach(c => {
    const input = document.getElementById(c.id);
    if (!input.value.trim()) {
      input.classList.add('is-invalid');
      errores.push(`• ${c.nombre} es obligatorio`);
      valido = false;
    }
  });

  // Validar correo
  const email = document.getElementById('email');
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (email.value && !emailRegex.test(email.value)) {
    email.classList.add('is-invalid');
    errores.push('• El correo no tiene un formato válido');
    valido = false;
  }

  if (!valido) {
    Swal.fire({
      icon: 'warning',
      title: 'Formulario incompleto',
      html: `
        <p>Corrige los siguientes errores:</p>
        <div style="text-align:left">${errores.join('<br>')}</div>
      `,
      confirmButtonText: 'Aceptar'
    });
    return false;
  }

  // Confirmación antes de guardar
  Swal.fire({
    icon: 'question',
    title: 'Confirmar cambios',
    text: '¿Deseas guardar los cambios en tu cuenta?',
    showCancelButton: true,
    confirmButtonText: 'Sí, guardar',
    cancelButtonText: 'Cancelar'
  }).then(result => {
    if (result.isConfirmed) {
      document.getElementById('editarCuentaForm').submit();
    }
  });

  return false; // detener submit normal
}
</script>
