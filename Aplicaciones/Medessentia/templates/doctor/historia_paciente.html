{% extends "dashboards/base_dashboard.html" %}
{% block title %}Historia · {{ perfil.user.get_full_name|default:perfil.user.username }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Encabezado + acciones -->
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0">
        Historia clínica de {{ perfil.user.first_name }} {{ perfil.user.last_name }}
        <span class="text-muted">({{ perfil.user.username }})</span>
      </h4>
      <div class="text-muted small">
        Cédula: {{ perfil.cedula_usuario }} · Tel: {{ perfil.telefono_usuario|default:"—" }}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'lista_perfiles' %}">← Volver</a>
      <a class="btn btn-primary" href="{% url 'nuevo_signo' perfil.id %}">+ Añadir signos</a>
      <button class="btn btn-outline-dark" onclick="window.print()">Imprimir</button>
    </div>
  </div>

  <!-- Filtros rápidos -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Buscar</label>
          <input id="tabla-search" type="text" class="form-control"
                 placeholder="Filtrar por fecha, PA, FC, FR, Temp, SpO₂, peso, glucosa, hemoglobina, observaciones…">
          <div class="form-text">Filtro en vivo (solo afecta la vista actual).</div>
        </div>
        <div class="col-md-8 text-end">
          <span class="badge text-bg-secondary">Registros: {{ signos|length }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="tabla-historia">
        <thead class="table-light">
          <tr>
            <th>Fecha</th><th>PAS</th><th>PAD</th><th>PAM</th><th>PA</th>
            <th>Temp</th><th>FR</th><th>FC</th><th>SpO₂</th>
            <th>Peso</th><th>Talla</th><th>IMC</th>
            <th>Glucosa</th><th>Hb</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for s in signos %}
          <tr>
            <td>{{ s.fecha_registro|date:"d/m/Y H:i" }}</td>
            <td>{{ s.pa_sistolica|default:"—" }}</td>
            <td>{{ s.pa_diastolica|default:"—" }}</td>
            <td>{{ s.pa_media|default:"—" }}</td>
            <td>{{ s.presion_arterial|default:"—" }}</td>
            <td>{{ s.temperatura }}</td>
            <td>{{ s.frecuencia_respiratoria }}</td>
            <td>{{ s.frecuencia_cardiaca }}</td>
            <td>{{ s.saturacion_oxigeno }}</td>
            <td>{{ s.peso }}</td>
            <td>{{ s.talla }}</td>
            <td>{{ s.imc|default:"—" }}</td>
            <td>{{ s.glucosa_capilar|default:"—" }}</td>
            <td>{{ s.hemoglobina|default:"—" }}</td>
            <td class="text-nowrap">
              <a class="btn btn-sm btn-outline-primary"
                 href="{% url 'editar_signo_vital' s.id %}">Editar</a>
              <button class="btn btn-sm btn-outline-danger"
                onclick="confirmarEliminar('{{ s.id }}','{{ s.fecha_registro|date:'d/m/Y H:i' }}')">
                Eliminar
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="15" class="text-center text-muted py-4">Sin registros.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card-footer text-muted small">
      Mostrando los signos vitales registrados para {{ perfil.user.get_full_name|default:perfil.user.username }}.
    </div>
  </div>
</div>

<!-- Form oculto para eliminar -->
<form id="formEliminarSigno" method="post" style="display:none;">
  {% csrf_token %}
</form>

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // Filtro en vivo
  (function () {
    const input = document.getElementById('tabla-search');
    input?.addEventListener('input', function () {
      const q = this.value.toLowerCase();
      document.querySelectorAll('#tabla-historia tbody tr').forEach(tr => {
        tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
      });
    });
  })();

  // SweetAlert eliminar
  function confirmarEliminar(id, fecha) {
    Swal.fire({
      title: '¿Eliminar registro?',
      html: `Registro del <strong>${fecha}</strong><br>Esta acción no se puede deshacer.`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        const form = document.getElementById('formEliminarSigno');
        form.action = "{% url 'eliminar_signo_vital' 0 %}".replace('/0/', `/${id}/`);
        form.submit();
      }
    });
  }
</script>
{% endblock %}
