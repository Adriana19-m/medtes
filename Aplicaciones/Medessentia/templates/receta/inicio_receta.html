{% extends "dashboards/base_dashboard.html" %}
{% load static %}
{% block title %}Recetas Médicas | Medessentia{% endblock %}
{% block page_title %}Recetas Médicas{% endblock %}

{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>Recetas Médicas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-actions {
            white-space: nowrap;
        }
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        @media print {
            body * {
                visibility: hidden !important;
            }
            .imprimir-modal,
            .imprimir-modal * {
                visibility: visible !important;
            }
            .imprimir-modal {
                position: fixed !important;
                inset: 0 !important;
                background: #fff !important;
                z-index: 99999 !important;
            }
            .modal-dialog {
                max-width: 100% !important;
                margin: 0 !important;
            }
            .modal-content {
                border: none !important;
                box-shadow: none !important;
            }
            .no-print,
            .modal-header,
            .btn,
            nav,
            header,
            aside,
            footer {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-prescription me-2"></i>Recetas Médicas</h4>
                    <button class="btn btn-light btn-sm" onclick="nuevaReceta()">
                        <i class="fas fa-plus me-1"></i> Nuevo
                    </button>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Barra de búsqueda y filtro -->
                <div class="row mb-3">
                    
                    <div class="col-md-6">
                        <select id="selectHistoria" class="form-select" onchange="cargarRecetas()">
                            <option value="">Todas las historias...</option>
                        </select>
                    </div>
                </div>

                <!-- Tabla -->
                <div class="table-responsive">
                    <table id="tablaRecetas" class="table table-striped table-bordered" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th width="100">N° Receta</th>
                                <th width="120">Expediente</th>
                                <th>Paciente</th>
                                <th width="120">Fecha</th>
                                <th>Motivo</th>
                                <th width="80">Medicam.</th>
                                <th width="100">Estado</th>
                                <th width="200" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Formulario -->
    <div class="modal fade" id="modalFormulario" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitulo">
                        <i class="fas fa-prescription me-2"></i>Receta Médica
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalContenido">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2">Cargando formulario...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detalle -->
    <div class="modal fade imprimir-modal" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white no-print">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>Detalle de Receta Médica
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-light btn-sm" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>Imprimir
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body" id="modalDetalleContenido"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
     <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.all.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
    let tabla = null;
    let modalFormulario = null;
    let modalDetalle = null;

    // Función para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Inicializar
    $(document).ready(function() {
        console.log("Iniciando módulo Recetas Médicas...");
        
        modalFormulario = new bootstrap.Modal(document.getElementById('modalFormulario'));
        modalDetalle = new bootstrap.Modal(document.getElementById('modalDetalle'));
        
        inicializarTabla();
        cargarHistorias();
        
        // Buscar con Enter
        $('#inputBuscar').on('keypress', function(e) {
            if (e.which === 13) {
                buscar();
            }
        });
    });

    function inicializarTabla() {
        tabla = $('#tablaRecetas').DataTable({
            data: [],
            columns: [
                { data: 'id_receta' },
                { data: 'expediente_no' },
                { data: 'paciente_nombre' },
                { data: 'fecha' },
                { data: 'motivo' },
                { 
                    data: 'cantidad_medicamentos',
                    render: function(data) {
                        return '<span class="badge bg-primary">' + data + '</span>';
                    }
                },
                { 
                    data: 'estado_display',
                    render: function(data, type, row) {
                        const badgeClass = row.estado === 'ACTIVA' ? 'bg-success' : 
                                         row.estado === 'ANULADA' ? 'bg-danger' : 
                                         row.estado === 'SURTIDA' ? 'bg-info' : 'bg-secondary';
                        return '<span class="badge ' + badgeClass + '">' + data + '</span>';
                    }
                },
                {
                    data: null,
                    className: 'table-actions text-center',
                    orderable: false,
                    render: function(data, type, row) {
                        let botones = '<div class="btn-group btn-group-sm">';
                        
                        botones += '<button class="btn btn-outline-info btn-action" onclick="verDetalle(' + row.id_receta + ')" title="Ver"><i class="fas fa-eye"></i></button>';
                        
                        if (row.puede_editar) {
                            botones += '<button class="btn btn-outline-primary btn-action" onclick="editarReceta(' + row.id_receta + ')" title="Editar"><i class="fas fa-edit"></i></button>';
                        }
                        
                        if (row.puede_anular) {
                            botones += '<button class="btn btn-outline-warning btn-action" onclick="anularReceta(' + row.id_receta + ')" title="Anular"><i class="fas fa-ban"></i></button>';
                        }
                        
                        if (row.puede_eliminar) {
                            botones += '<button class="btn btn-outline-danger btn-action" onclick="eliminarReceta(' + row.id_receta + ')" title="Eliminar"><i class="fas fa-trash"></i></button>';
                        }
                        
                        botones += '</div>';
                        return botones;
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json',
            },
            pageLength: 10,
            order: [[0, 'desc']]
        });
    }

    function buscar() {
        const valor = $('#inputBuscar').val().trim();

        if (!valor) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo obligatorio',
                text: 'Debe ingresar un criterio de búsqueda',
                confirmButtonText: 'Aceptar'
            });
            return;
        }

        tabla.search(valor).draw();

        // Verificar si hay resultados
        setTimeout(() => {
            if (tabla.rows({ filter: 'applied' }).data().length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'Sin resultados',
                    text: 'No se encontraron recetas con ese criterio',
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }, 200);
    }
    function limpiarBusqueda() {
        $('#inputBuscar').val('');
        tabla.search('').draw();

        Swal.fire({
            icon: 'success',
            title: 'Búsqueda limpiada',
            timer: 1000,
            showConfirmButton: false
        });
    }


    function cargarRecetas() {
        const historiaId = document.getElementById('selectHistoria').value;
        
        $.ajax({
            url: '{% url "recetas_listar" %}',
            method: 'GET',
            data: { historia_id: historiaId },
            success: function(data) {
                if (data.success && data.data) {
                    tabla.clear().rows.add(data.data).draw();
                } else {
                    tabla.clear().draw();
                }
            },
            error: function(xhr) {
                console.error('Error:', xhr);
                alert('✗ Error al cargar recetas');
            }
        });
    }

    function cargarHistorias() {
        $.ajax({
            url: '{% url "historias_listar" %}',
            method: 'GET',
            success: function(data) {
                const select = document.getElementById('selectHistoria');
                select.innerHTML = '<option value="">Todas las historias...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(historia => {
                        const option = document.createElement('option');
                        option.value = historia.id_historia;
                        option.textContent = historia.expediente_no + ' - ' + historia.paciente_nombre;
                        select.appendChild(option);
                    });
                }
                cargarRecetas();
            },
            error: function(xhr) {
                console.error('Error:', xhr);
                cargarRecetas();
            }
        });
    }

    function nuevaReceta() {
        const historiaId = document.getElementById('selectHistoria').value;
        
        if (!historiaId) {
            Swal.fire({
                icon: 'warning',
                title: 'Historia clínica requerida',
                text: 'Debe seleccionar una historia clínica antes de crear una receta',
                confirmButtonText: 'Aceptar'
            });
            return;
        }

        
        abrirFormulario(null, historiaId);
    }

    function abrirFormulario(recetaId = null, historiaId = null) {
        const titulo = recetaId ? 'Editar Receta' : 'Nueva Receta';
        document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-prescription me-2"></i>' + titulo;
        document.getElementById('modalContenido').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Cargando formulario...</p>
            </div>
        `;
        
        modalFormulario.show();
        
        const params = {};
        if (recetaId) params.receta_id = recetaId;
        if (historiaId) params.historia_id = historiaId;
        
        $.ajax({
            url: '{% url "recetas_formulario" %}',
            method: 'GET',
            data: params,
            success: function(data) {
                if (data.success && data.form_html) {
                    document.getElementById('modalContenido').innerHTML = data.form_html;
                    setTimeout(initFormularioReceta, 100);
                } else {
                    document.getElementById('modalContenido').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.error || 'Error al cargar el formulario'}
                        </div>
                    `;
                }
            },
            error: function(xhr) {
                document.getElementById('modalContenido').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar el formulario
                    </div>
                `;
            }
        });
    }

  function editarReceta(recetaId) {
        Swal.fire({
            title: 'Editar receta',



            text: '¿Desea editar esta receta médica?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, editar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#0d6efd'
        }).then((result) => {
            if (result.isConfirmed) {
                abrirFormulario(recetaId);
            }
        });
    }


    function verDetalle(recetaId) {
        document.getElementById('modalDetalleContenido').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Cargando detalles...</p>
            </div>
        `;
        
        modalDetalle.show();
        
        $.ajax({
            url: '{% url "recetas_detalle" 0 %}'.replace('0', recetaId),
            method: 'GET',
            success: function(data) {
                if (data.success && data.data) {
                    mostrarDetalles(data.data);
                } else {
                    document.getElementById('modalDetalleContenido').innerHTML = `
                        <div class="alert alert-danger">${data.error || 'Error'}</div>
                    `;
                }
            },
            error: function(xhr) {
                document.getElementById('modalDetalleContenido').innerHTML = `
                    <div class="alert alert-danger">Error al cargar</div>
                `;
            }
        });
    }

    function mostrarDetalles(datos) {
        let html = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6 class="border-bottom pb-2 fw-bold">Información de la Receta</h6>
                    <p><strong>N° Receta:</strong> ${datos.id_receta}</p>
                    <p><strong>Paciente:</strong> ${datos.paciente_nombre}</p>
                    <p><strong>Expediente:</strong> ${datos.expediente_no}</p>
                    <p><strong>Cédula:</strong> ${datos.cedula}</p>
                    <p><strong>Fecha:</strong> ${datos.fecha}</p>
                </div>
                <div class="col-md-6">
                    <h6 class="border-bottom pb-2 fw-bold">Datos Médicos</h6>
                    <p><strong>Motivo:</strong> ${datos.motivo || 'No especificado'}</p>
                    <p><strong>Estado:</strong> <span class="badge ${datos.estado === 'ACTIVA' ? 'bg-success' : 'bg-danger'}">${datos.estado_display}</span></p>
                    <p><strong>Doctor:</strong> ${datos.doctor_nombre}</p>
                </div>
            </div>
            
            <h6 class="border-bottom pb-2 fw-bold">Medicamentos Recetados</h6>`;
        
        if (datos.detalles && datos.detalles.length > 0) {
            datos.detalles.forEach((detalle, index) => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">${index + 1}. ${detalle.medicamento}</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <small><strong>Concentración:</strong> ${detalle.concentracion || 'N/A'}</small><br>
                                    <small><strong>Presentación:</strong> ${detalle.presentacion || 'N/A'}</small>
                                </div>
                                <div class="col-md-4">
                                    <small><strong>Dosis:</strong> ${detalle.dosis}</small><br>
                                    <small><strong>Frecuencia:</strong> ${detalle.frecuencia}</small>
                                </div>
                                <div class="col-md-4">
                                    <small><strong>Duración:</strong> ${detalle.duracion_dias} días</small><br>
                                    <small><strong>Cantidad:</strong> ${detalle.cantidad_total}</small><br>
                                    <small><strong>Vía:</strong> ${detalle.via_administracion}</small>
                                </div>
                            </div>`;
                
                if (detalle.indicaciones) html += `<small><strong>Indicaciones:</strong> ${detalle.indicaciones}</small><br>`;
                if (detalle.advertencias) html += `<small><strong>Advertencias:</strong> ${detalle.advertencias}</small>`;
                
                html += `</div></div>`;
            });
        }
        
        if (datos.observaciones) {
            html += `
                <h6 class="border-bottom pb-2 fw-bold mt-3">Observaciones</h6>
                <p>${datos.observaciones}</p>`;
        }
        
        document.getElementById('modalDetalleContenido').innerHTML = html;
    }
    function anularReceta(recetaId) {
        Swal.fire({
            title: '¿Anular receta?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, anular',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#f0ad4e'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '{% url "recetas_anular" %}',
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    data: JSON.stringify({ id_receta: recetaId }),
                    contentType: 'application/json',
                    success: function(res) {
                        if (res.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Receta anulada',
                                text: res.message,
                                timer: 1500,
                                showConfirmButton: false
                            });
                            cargarRecetas();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: res.error || 'No se pudo anular la receta'
                            });
                        }
                    },
                    error: function(xhr) {
                        console.error('Error:', xhr);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de servidor',
                            text: 'Ocurrió un error al anular la receta'
                        });
                    }
                });
            }
        });
    }


    function eliminarReceta(recetaId) {
        Swal.fire({
            title: '¿Eliminar receta?',
            text: 'Esta acción es irreversible',
            icon: 'error',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '{% url "recetas_eliminar" %}',
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    data: JSON.stringify({ id_receta: recetaId }),
                    contentType: 'application/json',
                    success: function(res) {
                        if (res.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Receta eliminada',
                                text: res.message,
                                timer: 1500,
                                showConfirmButton: false
                            });
                            cargarRecetas();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: res.error || 'No se pudo eliminar la receta'
                            });
                        }
                    },
                    error: function(xhr) {
                        console.error('Error:', xhr);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de servidor',
                            text: 'Ocurrió un error al eliminar la receta'
                        });
                    }
                });
            }
        });
    }


    // Inicializar formulario
    function initFormularioReceta() {
        console.log('Inicializando formulario de receta...');
        
        const form = document.getElementById('formReceta');
        const seccion = document.getElementById('seccionMedicamentos');
        
        if (!form) {
            console.error('Formulario no encontrado');
            return;
        }
        
        const btnAgregar = document.getElementById('btnAgregarMedicamento');
        if (btnAgregar) {
            btnAgregar.onclick = () => {
                const i = seccion.querySelectorAll('.medicamento-item').length;
                
                seccion.insertAdjacentHTML('beforeend', `
                <div class="card mb-2 medicamento-item">
                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                        <strong><i class="fas fa-pills me-1"></i>Medicamento ${i + 1}</strong>
                        <button type="button" class="btn btn-sm btn-danger eliminar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label fw-bold">Medicamento *</label>
                                <input class="form-control" name="detalles[${i}][medicamento]" placeholder="Nombre del medicamento" required>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label fw-bold">Concentración</label>
                                <input class="form-control" name="detalles[${i}][concentracion]" placeholder="Ej: 500mg">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label fw-bold">Presentación</label>
                                <input class="form-control" name="detalles[${i}][presentacion]" placeholder="Ej: Tabletas">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label fw-bold">Dosis *</label>
                                <input class="form-control" name="detalles[${i}][dosis]" placeholder="Ej: 1 tableta" required>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label fw-bold">Frecuencia *</label>
                                <input class="form-control" name="detalles[${i}][frecuencia]" placeholder="Ej: Cada 8 horas" required>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label fw-bold">Días *</label>
                                <input class="form-control" type="number" min="1" name="detalles[${i}][duracion_dias]" placeholder="7" required>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label fw-bold">Cantidad *</label>
                                <input class="form-control" type="number" min="1" name="detalles[${i}][cantidad_total]" placeholder="21" required>
                            </div>
                            <div class="col-md-12 mb-2">
                                <label class="form-label fw-bold">Vía de Administración *</label>
                                <select class="form-select" name="detalles[${i}][via_administracion]" required>
                                    <option value="">Seleccione...</option>
                                    <option value="ORAL">ORAL</option>
                                    <option value="INYECTABLE">INYECTABLE</option>
                                    <option value="TOPICA">TÓPICA</option>
                                    <option value="INHALATORIA">INHALATORIA</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label fw-bold">Indicaciones</label>
                                <textarea class="form-control" name="detalles[${i}][indicaciones]" placeholder="Instrucciones de uso" rows="2"></textarea>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label fw-bold">Advertencias</label>
                                <textarea class="form-control" name="detalles[${i}][advertencias]" placeholder="Advertencias o precauciones" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>`);
            };
        }
        
        seccion.addEventListener('click', e => {
            if (e.target.closest('.eliminar')) {
                if (confirm('¿Eliminar este medicamento?')) {
                    e.target.closest('.medicamento-item').remove();
                }
            }
        });
        
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            /* =========================
            VALIDACIÓN: MOTIVO
            ========================= */
            const motivoInput = form.querySelector('[name="motivo"]');
            const motivo = motivoInput.value.trim();

            if (!motivo) {
                motivoInput.classList.add('is-invalid');

                Swal.fire({
                    icon: 'warning',
                    title: 'Campo obligatorio',
                    text: 'El motivo de la receta es requerido',
                    confirmButtonText: 'Aceptar'
                });

                motivoInput.focus();
                return;
            } else {
                motivoInput.classList.remove('is-invalid');
            }

            /* =========================
            VALIDACIÓN: MEDICAMENTOS
            ========================= */
            const medicamentos = form.querySelectorAll('.medicamento-item');

            if (medicamentos.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Medicamentos requeridos',
                    text: 'Debe agregar al menos un medicamento',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            /* =========================
            VALIDACIÓN: CAMPOS DE CADA MEDICAMENTO
            ========================= */
            let error = false;

            medicamentos.forEach((item, index) => {
                const requiredFields = [
                    'medicamento',
                    'concentracion',
                    'presentacion',
                    'dosis',
                    'frecuencia',
                    'duracion_dias',
                    'cantidad_total',
                    'via_administracion',
                    'indicaciones',
                    'advertencias'
                ];

                requiredFields.forEach(field => {
                    const input = item.querySelector(`[name="detalles[${index}][${field}]"]`);
                    if (input && !input.value.trim()) {
                        input.classList.add('is-invalid');
                        error = true;
                    } else if (input) {
                        input.classList.remove('is-invalid');
                    }
                });
            });

            if (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Formulario incompleto',
                    text: 'Complete todos los campos obligatorios de los medicamentos',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            /* =========================
            ARMAR DATA
            ========================= */
            const csrf = form.querySelector('[name=csrfmiddlewaretoken]').value;

            const data = {
                id_receta: form.querySelector('[name="id_receta"]')?.value || '',
                id_historia: form.querySelector('[name="id_historia"]').value,
                motivo: motivo,
                observaciones: form.querySelector('[name="observaciones"]')?.value || '',
                detalles: []
            };

            medicamentos.forEach((item, index) => {
                const getVal = (name) => {
                    const el = item.querySelector(`[name="detalles[${index}][${name}]"]`);
                    return el ? el.value.trim() : '';
                };

                data.detalles.push({
                    medicamento: getVal('medicamento'),
                    concentracion: getVal('concentracion'),
                    presentacion: getVal('presentacion'),
                    dosis: getVal('dosis'),
                    frecuencia: getVal('frecuencia'),
                    duracion_dias: parseInt(getVal('duracion_dias')) || 0,
                    cantidad_total: parseInt(getVal('cantidad_total')) || 0,
                    via_administracion: getVal('via_administracion'),
                    indicaciones: getVal('indicaciones'),
                    advertencias: getVal('advertencias')
                });
            });

            /* =========================
            BOTÓN LOADING
            ========================= */
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';
            submitBtn.disabled = true;

            /* =========================
            FETCH
            ========================= */
            fetch('{% url "recetas_guardar" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(res => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;

                    if (res.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Receta guardada',
                            text: res.message,
                            timer: 1500,
                            showConfirmButton: false
                        });

                        modalFormulario.hide();
                        setTimeout(() => cargarRecetas(), 500);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: res.error || 'Error al guardar la receta'
                        });
                    }
                })
                .catch(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;

                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexión',
                        text: 'No se pudo guardar la receta'
                    });
                });
        });

        
        const btnCancelar = document.getElementById('btnCancelarReceta');
            if (btnCancelar) {
                btnCancelar.onclick = () => {
                    Swal.fire({
                        title: '¿Descartar cambios?',
                        text: 'Los cambios no guardados se perderán',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, salir',
                        cancelButtonText: 'Continuar editando'
                    }).then(result => {
                        if (result.isConfirmed) {
                            modalFormulario.hide();
                        }
                    });
                };
            }

        
        console.log('Formulario inicializado correctamente');
    }
    </script>
</body>
</html>
{% endblock %}