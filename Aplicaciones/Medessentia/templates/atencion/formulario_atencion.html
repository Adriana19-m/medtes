<form id="formAtencion" autocomplete="off">
    {% csrf_token %}
    <input type="hidden" name="id_atencion" value="{{ atencion.id_atencion|default:'' }}">
    
    <!-- Acorde√≥n Principal -->
    <div class="accordion" id="accordionAtencion">
        
        <!-- 1. IDENTIFICACI√ìN -->
        <div class="accordion-item mb-2">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#seccion1">
                    <i class="fas fa-user me-2"></i>1. IDENTIFICACI√ìN DEL PACIENTE
                </button>
            </h2>
            <div id="seccion1" class="accordion-collapse collapse show" data-bs-parent="#accordionAtencion">
                <div class="accordion-body">
                    <!-- B√∫squeda de historia cl√≠nica -->
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-search me-2"></i>Buscar Historia Cl√≠nica
                        </div>
                        <div class="card-body">
                            <input type="hidden" name="historia_id" id="historia_id" value="{{ atencion.id_historia.id_historia|default:'' }}">
                            
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">Buscar Paciente/Historia <span class="badge bg-danger rounded-pill ms-1" style="font-size: 0.6em; padding: 2px 6px;">Campo obligatorio</span></label>
                                    <input type="text" class="form-control" id="buscarHistoriaInput" 
                                           placeholder="Escriba expediente, nombre o c√©dula del paciente..." 
                                           value="{% if atencion and atencion.id_historia %}{{ atencion.id_historia.expediente_no }} - {{ atencion.id_historia.nombres_completos }}{% endif %}">
                                    <div id="resultadosBusquedaHistoria" class="list-group mt-2" style="display:none; max-height:200px; overflow-y:auto; position:absolute; z-index:1000; width:calc(66.666% - 1rem);"></div>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="button" class="btn btn-success w-100" onclick="abrirNuevaHistoria()">
                                        <i class="fas fa-file-medical me-2"></i>Nueva Historia
                                    </button>
                                </div>
                            </div>
                            
                            <div id="historiaSeleccionada" class="alert alert-success mt-3" style="display:{% if atencion and atencion.id_historia %}block{% else %}none{% endif %}">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Paciente seleccionado:</strong> 
                                <span id="nombrePacienteSeleccionado">
                                    {% if atencion and atencion.id_historia %}{{ atencion.id_historia.expediente_no }} - {{ atencion.id_historia.nombres_completos }}{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Doctor Responsable</label>
                            <input type="text" class="form-control" value="{{ usuario_actual.first_name }} {{ usuario_actual.last_name }}" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Fecha y Hora <span class="badge bg-danger rounded-pill ms-1" style="font-size: 0.6em; padding: 2px 6px;">Obligatorio</span></label>
                            <input type="datetime-local" name="fecha_atencion" id="fecha_atencion" class="form-control" 
                                   value="{% if atencion and atencion.fecha_atencion %}{{ atencion.fecha_atencion|date:'Y-m-d\TH:i' }}{% endif %}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Tipo de Atenci√≥n <span class="badge bg-danger rounded-pill ms-1" style="font-size: 0.6em; padding: 2px 6px;">Obligatorio</span></label>
                            <select name="tipo_atencion" class="form-select" required>
                                <option value="">Seleccione...</option>
                                <option value="PRIMERA_VEZ" {% if atencion and atencion.tipo_atencion == 'PRIMERA_VEZ' %}selected{% endif %}>Primera Vez</option>
                                <option value="CONTROL" {% if atencion and atencion.tipo_atencion == 'CONTROL' %}selected{% endif %}>Control</option>
                                <option value="EMERGENCIA" {% if atencion and atencion.tipo_atencion == 'EMERGENCIA' %}selected{% endif %}>Emergencia</option>
                                <option value="TELECONSULTA" {% if atencion and atencion.tipo_atencion == 'TELECONSULTA' %}selected{% endif %}>Teleconsulta</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. MOTIVO -->
        <div class="accordion-item mb-2">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#seccion2">
                    <i class="fas fa-comment-medical me-2"></i>2. MOTIVO DE CONSULTA
                </button>
            </h2>
            <div id="seccion2" class="accordion-collapse collapse" data-bs-parent="#accordionAtencion">
                <div class="accordion-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Motivo de Consulta <span class="badge bg-danger rounded-pill ms-1" style="font-size: 0.6em; padding: 2px 6px;">Obligatorio</span></label>
                        <textarea name="motivo_consulta" class="form-control" rows="4" required>{% if atencion %}{{ atencion.motivo_consulta|default:'' }}{% endif %}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Enfermedad Actual</label>
                        <textarea name="enfermedad_actual" class="form-control" rows="4">{% if atencion %}{{ atencion.enfermedad_actual|default:'' }}{% endif %}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. SIGNOS VITALES -->
        <div class="accordion-item mb-2">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#seccion3">
                    <i class="fas fa-heartbeat me-2"></i>3. SIGNOS VITALES
                </button>
            </h2>
            <div id="seccion3" class="accordion-collapse collapse" data-bs-parent="#accordionAtencion">
                <div class="accordion-body">
                    <!-- Alerta de signos vitales previos -->
                    <div id="alertaSignosPrevios" class="alert alert-info" style="display:none;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>√öltimos signos vitales registrados:</strong>
                                <span id="fechaUltimosSignos"></span>
                            </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="cargarSignosPrevios()">
                                    <i class="fas fa-download me-1"></i>Cargar Datos
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="cerrarAlertaSignos()">
                                    <i class="fas fa-times me-1"></i>Ingresar Nuevos
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Presi√≥n Arterial</label>
                            <div class="input-group">
                                <input type="text" name="presion_sistolica" id="presion_sistolica" class="form-control" placeholder="Sist√≥lica" 
                                       value="{% if atencion %}{{ atencion.presion_sistolica|default:'' }}{% endif %}">
                                <span class="input-group-text">/</span>
                                <input type="text" name="presion_diastolica" id="presion_diastolica" class="form-control" placeholder="Diast√≥lica" 
                                       value="{% if atencion %}{{ atencion.presion_diastolica|default:'' }}{% endif %}">
                                <span class="input-group-text">mmHg</span>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Temperatura</label>
                            <div class="input-group">
                                <input type="number" name="temperatura" id="temperatura" class="form-control" step="0.1" 
                                       value="{% if atencion %}{{ atencion.temperatura|default:'' }}{% endif %}">
                                <span class="input-group-text">¬∞C</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">F. Respiratoria</label>
                            <div class="input-group">
                                <input type="number" name="frecuencia_respiratoria" id="frecuencia_respiratoria" class="form-control" 
                                       value="{% if atencion %}{{ atencion.frecuencia_respiratoria|default:'' }}{% endif %}">
                                <span class="input-group-text">rpm</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">F. Card√≠aca</label>
                            <div class="input-group">
                                <input type="number" name="frecuencia_cardiaca" id="frecuencia_cardiaca" class="form-control" 
                                       value="{% if atencion %}{{ atencion.frecuencia_cardiaca|default:'' }}{% endif %}">
                                <span class="input-group-text">lpm</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Sat. Ox√≠geno</label>
                            <div class="input-group">
                                <input type="number" name="saturacion_oxigeno" id="saturacion_oxigeno" class="form-control" 
                                       value="{% if atencion %}{{ atencion.saturacion_oxigeno|default:'' }}{% endif %}">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Peso</label>
                            <div class="input-group">
                                <input type="number" name="peso" id="peso" class="form-control" step="0.01" 
                                       value="{% if atencion %}{{ atencion.peso|default:'' }}{% endif %}" onchange="calcularIMC()">
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Talla</label>
                            <div class="input-group">
                                <input type="number" name="talla" id="talla" class="form-control" step="0.01" 
                                       value="{% if atencion %}{{ atencion.talla|default:'' }}{% endif %}" onchange="calcularIMC()">
                                <span class="input-group-text">cm</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">IMC</label>
                            <input type="text" name="imc" id="imc" class="form-control" 
                                   value="{% if atencion %}{{ atencion.imc|default:'' }}{% endif %}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. EXAMEN F√çSICO -->
        <div class="accordion-item mb-2">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#seccion4">
                    <i class="fas fa-stethoscope me-2"></i>4. EXAMEN F√çSICO POR SISTEMAS
                </button>
            </h2>
            <div id="seccion4" class="accordion-collapse collapse" data-bs-parent="#accordionAtencion">
                <div class="accordion-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">√ìrganos Sentidos</label>
                            <textarea name="organos_sentidos" class="form-control" rows="2">{% if atencion %}{{ atencion.organos_sentidos|default:'' }}{% endif %}</textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sistema Respiratorio</label>
                            <textarea name="respiratorio" class="form-control" rows="2">{% if atencion %}{{ atencion.respiratorio|default:'' }}{% endif %}</textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sistema Cardiovascular</label>
                            <textarea name="cardiovascular" class="form-control" rows="2">{% if atencion %}{{ atencion.cardiovascular|default:'' }}{% endif %}</textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sistema Digestivo</label>
                            <textarea name="digestivo" class="form-control" rows="2">{% if atencion %}{{ atencion.digestivo|default:'' }}{% endif %}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. DIAGN√ìSTICO -->
        <div class="accordion-item mb-2">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#seccion5">
                    <i class="fas fa-diagnoses me-2"></i>5. DIAGN√ìSTICO
                </button>
            </h2>
            <div id="seccion5" class="accordion-collapse collapse" data-bs-parent="#accordionAtencion">
                <div class="accordion-body">
                    <!-- B√∫squeda CIE-10 -->
                    <div class="card border-warning mb-3">
                        <div class="card-header bg-warning">
                            <i class="fas fa-search me-2"></i>Buscar Diagn√≥stico CIE-10
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">C√≥digo o Descripci√≥n CIE-10</label>
                                    <input type="text" class="form-control" id="buscarCie10Input" 
                                           placeholder="Escriba c√≥digo o descripci√≥n...">
                                    <div id="resultadosBusquedaCie10" class="list-group mt-2" style="display:none; max-height:200px; overflow-y:auto; position:absolute; z-index:1000; width:calc(66.666% - 1rem);"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">C√≥digo CIE-10</label>
                            <input type="text" name="cie10_codigo" id="cie10_codigo" class="form-control" 
                                   value="{% if atencion %}{{ atencion.cie10_codigo|default:'' }}{% endif %}">
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Descripci√≥n CIE-10</label>
                            <input type="text" name="cie10_descripcion" id="cie10_descripcion" class="form-control" 
                                   value="{% if atencion %}{{ atencion.cie10_descripcion|default:'' }}{% endif %}">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observaciones del Diagn√≥stico</label>
                            <textarea name="diagnostico_observaciones" class="form-control" rows="3">{% if atencion %}{{ atencion.diagnostico_observaciones|default:'' }}{% endif %}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. PLAN DE TRATAMIENTO -->
        <div class="accordion-item mb-2">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#seccion6">
                    <i class="fas fa-prescription me-2"></i>6. PLAN DE TRATAMIENTO
                </button>
            </h2>
            <div id="seccion6" class="accordion-collapse collapse" data-bs-parent="#accordionAtencion">
                <div class="accordion-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Plan de Tratamiento</label>
                        <textarea name="plan_tratamiento" class="form-control" rows="4">{% if atencion %}{{ atencion.plan_tratamiento|default:'' }}{% endif %}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tratamiento No Farmacol√≥gico</label>
                        <textarea name="tratamiento_no_farmacologico" class="form-control" rows="3">{% if atencion %}{{ atencion.tratamiento_no_farmacologico|default:'' }}{% endif %}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Evoluci√≥n</label>
                        <textarea name="evolucion" class="form-control" rows="3">{% if atencion %}{{ atencion.evolucion|default:'' }}{% endif %}</textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones -->
    <div class="border-top pt-3 mt-3">
        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i> Cancelar
            </button>
            <button type="button" class="btn btn-primary btn-guardar" onclick="guardarFormulario()">
                <i class="fas fa-save me-1"></i> Guardar
            </button>
        </div>
    </div>
</form>

<style>
    .campo-obligatorio {
        display: inline-block;
        background-color: #dc3545;
        color: white;
        font-size: 0.7em;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: 5px;
        font-weight: normal;
        vertical-align: middle;
    }
    .campo-obligatorio:hover {
        background-color: #c82333;
    }
    .campo-error {
        border: 2px solid #dc3545 !important;
        background-color: #fff5f5;
    }
    .mensaje-error {
        color: #dc3545;
        font-size: 0.85rem;
        margin-top: 4px;
    }
    .is-invalid {
        border-color: #dc3545 !important;
        background-color: #fff5f5;
    }
    .invalid-feedback {
        display: block;
        font-size: 0.85rem;
    }
    .bg-success-subtle {
        background-color: #d1e7dd !important;
        transition: background-color 0.5s ease;
    }
</style>

<script>
let timeoutBusquedaHistoria = null;
let timeoutBusquedaCie10 = null;
let signosPreviosCache = null;

// INICIALIZAR FORMULARIO - SIEMPRE SE EJECUTA
function inicializarFormulario() {
    console.log('üìù Inicializando formulario completo...');
    
    // Limpiar cache
    signosPreviosCache = null;
    $('#alertaSignosPrevios').hide();
    
    // Fecha actual si est√° vac√≠a
    const fechaInput = document.getElementById('fecha_atencion');
    if (fechaInput && !fechaInput.value) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        fechaInput.value = now.toISOString().slice(0, 16);
    }

$('#modalFormulario').on('hidden.bs.modal', function () {
    $('#buscarHistoriaInput').val('');
    $('#resultadosBusquedaHistoria').hide();
    $('#historia_id').val('');
    $('#historiaSeleccionada').hide();
});

let timeoutBusquedaHistoria = null;
let timeoutBusquedaCie10 = null;

document.addEventListener('input', function (e) {

    // üîç BUSCAR HISTORIAS
    if (e.target && e.target.id === 'buscarHistoriaInput') {
        clearTimeout(timeoutBusquedaHistoria);
        const query = e.target.value.trim();

        if (query.length < 2) {
            $('#resultadosBusquedaHistoria').hide();
            return;
        }

        timeoutBusquedaHistoria = setTimeout(() => {
            buscarHistorias(query);
        }, 300);
    }

    // üîç BUSCAR CIE-10
    if (e.target && e.target.id === 'buscarCie10Input') {
        clearTimeout(timeoutBusquedaCie10);
        const query = e.target.value.trim();

        if (query.length < 2) {
            $('#resultadosBusquedaCie10').hide();
            return;
        }

        timeoutBusquedaCie10 = setTimeout(() => {
            buscarCIE10(query);
        }, 300);
    }

});



    const inputCie10 = document.getElementById('buscarCie10Input');
    if (inputCie10) {
        // Clonar el elemento para remover todos los event listeners
        const nuevoInput = inputCie10.cloneNode(true);
        inputCie10.parentNode.replaceChild(nuevoInput, inputCie10);
        
        // Agregar nuevo event listener
        nuevoInput.addEventListener('input', function() {
            clearTimeout(timeoutBusquedaCie10);
            const query = this.value.trim();
            
            if (query.length < 2) {
                $('#resultadosBusquedaCie10').hide();
                return;
            }
            
            timeoutBusquedaCie10 = setTimeout(() => buscarCIE10(query), 300);
        });
        console.log('‚úÖ B√∫squeda CIE-10 reinicializada');
    }

    // Si hay historia, buscar signos
    const historiaId = document.getElementById('historia_id').value;
    if (historiaId) {
        console.log('üîÑ Historia seleccionada, buscando signos...');
        buscarSignosPrevios(historiaId);
    }

    // Focus en b√∫squeda si no hay paciente
    const buscarInput = document.getElementById('buscarHistoriaInput');
    if (buscarInput && !buscarInput.value) {
        setTimeout(() => buscarInput.focus(), 300);
    }
}

// Llamar inicializaci√≥n cuando el DOM est√© listo Y cada vez que se carga el formulario
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarFormulario);
} else {
    inicializarFormulario();
}

function buscarHistorias(query) {
    $.ajax({
        url: '{% url "buscar_historias_atencion" %}',
        type: 'GET',
        data: { q: query },
        success: function(response) {
            const div = $('#resultadosBusquedaHistoria');
            div.empty();
            
            if (response.data && response.data.length > 0) {
                response.data.forEach(historia => {
                    const item = $(`
                        <a href="#" class="list-group-item list-group-item-action" 
                           data-id="${historia.id_historia}" 
                           data-expediente="${historia.expediente}"
                           data-paciente="${historia.paciente}">
                            <div><strong>${historia.expediente} - ${historia.paciente}</strong></div>
                            <small class="text-muted">${historia.cedula} | ${historia.sexo}</small>
                        </a>
                    `);
                    
                    item.on('click', function(e) {
                        e.preventDefault();
                        seleccionarHistoria($(this).data('id'), $(this).data('expediente'), $(this).data('paciente'));
                    });
                    
                    div.append(item);
                });
                div.show();
            } else {
                div.html('<div class="list-group-item text-muted">No se encontraron resultados</div>').show();
            }
        },
        error: function() {
            console.error('Error en b√∫squeda de historias');
        }
    });
}

function buscarCIE10(query) {
    $.ajax({
        url: '{% url "buscar_cie10_atencion" %}',
        type: 'GET',
        data: { q: query },
        success: function(response) {
            const div = $('#resultadosBusquedaCie10');
            div.empty();
            
            if (response.data && response.data.length > 0) {
                response.data.forEach(cie => {
                    const item = $(`
                        <a href="#" class="list-group-item list-group-item-action" 
                           data-codigo="${cie.codigo}"
                           data-descripcion="${cie.descripcion}">
                            <div><strong>${cie.codigo}</strong></div>
                            <small class="text-muted">${cie.descripcion}</small>
                        </a>
                    `);
                    
                    item.on('click', function(e) {
                        e.preventDefault();
                        $('#cie10_codigo').val($(this).data('codigo'));
                        $('#cie10_descripcion').val($(this).data('descripcion'));
                        $('#buscarCie10Input').val('');
                        div.hide();
                    });
                    
                    div.append(item);
                });
                div.show();
            } else {
                div.html('<div class="list-group-item text-muted">No se encontraron resultados</div>').show();
            }
        },
        error: function() {
            console.error('Error en b√∫squeda CIE-10');
        }
    });
}

function seleccionarHistoria(id, expediente, paciente) {
    console.log('üë§ Seleccionando historia:', id);
    
    // Limpiar cache anterior
    signosPreviosCache = null;
    $('#alertaSignosPrevios').hide();
    
    // Guardar selecci√≥n
    $('#historia_id').val(id);
    $('#buscarHistoriaInput').val(`${expediente} - ${paciente}`);
    $('#nombrePacienteSeleccionado').text(`${expediente} - ${paciente}`);
    $('#historiaSeleccionada').show();
    $('#resultadosBusquedaHistoria').hide();
    
    // Buscar signos vitales
    buscarSignosPrevios(id);
}

function buscarSignosPrevios(historiaId) {
    console.log('üîç Buscando signos previos...');
    
    $.ajax({
        url: '{% url "obtener_ultimos_signos" %}',
        type: 'GET',
        data: { historia_id: historiaId },
        success: function(response) {
            if (response.success && response.signos) {
                console.log('‚úÖ Signos encontrados');
                signosPreviosCache = response.signos;
                
                // Mostrar alerta
                $('#fechaUltimosSignos').text(response.signos.fecha_registro);
                $('#alertaSignosPrevios').show();
                
                // Abrir secci√≥n
                const seccionSignos = document.getElementById('seccion3');
                if (seccionSignos && !seccionSignos.classList.contains('show')) {
                    const botonSignos = document.querySelector('[data-bs-target="#seccion3"]');
                    if (botonSignos) botonSignos.click();
                }
                
                // Preguntar
                Swal.fire({
                    icon: 'question',
                    title: 'Signos Vitales Disponibles',
                    html: `<p><strong>Fecha:</strong> ${response.signos.fecha_registro}</p><p>¬øDesea cargar estos signos vitales?</p>`,
                    showDenyButton: true,
                    confirmButtonText: '<i class="fas fa-download me-1"></i> Cargar',
                    denyButtonText: '<i class="fas fa-edit me-1"></i> Nuevos',
                    confirmButtonColor: '#0d6efd',
                    denyButtonColor: '#6c757d'
                }).then((result) => {
                    if (result.isConfirmed) {
                        cargarSignosPrevios();
                        Swal.fire({ icon: 'success', title: 'Datos Cargados', timer: 1500, showConfirmButton: false });
                    } else if (result.isDenied) {
                        cerrarAlertaSignos();
                    }
                });
            } else {
                console.log('‚ö†Ô∏è Sin signos previos');
                $('#alertaSignosPrevios').hide();
            }
        },
        error: function(xhr, status, error) {
            console.error('‚ùå Error en AJAX:', error);
            $('#alertaSignosPrevios').hide();
            signosPreviosCache = null;
        }
    });
}

function cargarSignosPrevios() {
    if (!signosPreviosCache) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'No hay signos vitales previos disponibles', timer: 1500, showConfirmButton: false });
        return;
    }
    
    // Cargar datos
    $('#presion_sistolica').val(signosPreviosCache.presion_sistolica || '');
    $('#presion_diastolica').val(signosPreviosCache.presion_diastolica || '');
    $('#temperatura').val(signosPreviosCache.temperatura || '');
    $('#frecuencia_respiratoria').val(signosPreviosCache.frecuencia_respiratoria || '');
    $('#frecuencia_cardiaca').val(signosPreviosCache.frecuencia_cardiaca || '');
    $('#saturacion_oxigeno').val(signosPreviosCache.saturacion_oxigeno || '');
    $('#peso').val(signosPreviosCache.peso || '');
    $('#talla').val(signosPreviosCache.talla || '');
    $('#imc').val(signosPreviosCache.imc || '');
    
    // Resaltar campos
    $('.form-control', '#seccion3').addClass('bg-success-subtle');
    setTimeout(() => $('.form-control', '#seccion3').removeClass('bg-success-subtle'), 2000);
    
    $('#alertaSignosPrevios').fadeOut();
}

function cerrarAlertaSignos() {
    $('#alertaSignosPrevios').fadeOut();
    signosPreviosCache = null;
}

function abrirNuevaHistoria() {
    Swal.fire({
        icon: 'question',
        title: 'Nueva historia cl√≠nica',
        text: '¬øDesea crear una nueva historia cl√≠nica?',
        showCancelButton: true,
        confirmButtonText: 'S√≠, crear',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = '{% url "inicio_historiaclinica" %}';
        }
    });
}

function calcularIMC() {
    const peso = parseFloat($('#peso').val());
    const talla = parseFloat($('#talla').val());
    
    if (peso && talla && talla > 0) {
        const imc = peso / Math.pow(talla / 100, 2);
        $('#imc').val(imc.toFixed(2));
    } else {
        $('#imc').val('');
    }
}

function guardarFormulario() {
    const form = document.getElementById('formAtencion');
    const formData = new FormData(form);
    
    // Validar campos obligatorios
    const historiaId = formData.get('historia_id');
    const fechaAtencion = formData.get('fecha_atencion');
    const tipoAtencion = formData.get('tipo_atencion');
    const motivoConsulta = formData.get('motivo_consulta');
    
    if (!historiaId) {
        Swal.fire({ icon: 'warning', title: 'Paciente no seleccionado', text: 'Debe seleccionar una historia cl√≠nica del paciente' })
            .then(() => document.getElementById('buscarHistoriaInput').focus());
        return;
    }
    
    if (!fechaAtencion) {
        Swal.fire({ icon: 'warning', title: 'Campo obligatorio', text: 'La fecha y hora de atenci√≥n son obligatorias' })
            .then(() => document.getElementById('fecha_atencion').focus());
        return;
    }
    
    if (!tipoAtencion) {
        Swal.fire({ icon: 'warning', title: 'Campo obligatorio', text: 'Debe seleccionar el tipo de atenci√≥n' })
            .then(() => document.querySelector('select[name="tipo_atencion"]').focus());
        return;
    }
    
    if (!motivoConsulta || motivoConsulta.trim() === '') {
        Swal.fire({ icon: 'warning', title: 'Campo obligatorio', text: 'El motivo de consulta es obligatorio' })
            .then(() => document.querySelector('textarea[name="motivo_consulta"]').focus());
        return;
    }
    
    // Deshabilitar bot√≥n
    const btnGuardar = document.querySelector('.btn-guardar');
    const originalText = btnGuardar.innerHTML;
    btnGuardar.disabled = true;
    btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';
    
    Swal.fire({ title: 'Guardando atenci√≥n m√©dica...', text: 'Por favor espere', allowOutsideClick: false, allowEscapeKey: false, didOpen: () => Swal.showLoading() });
    
    // Enviar datos
    fetch('{% url "guardar_atencion" %}', {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCSRFToken() }
    })
    .then(response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new TypeError('La respuesta no es JSON');
        }
        return response.json();
    })
    .then(data => {
        Swal.close();
        if (data.success) {
            Swal.fire({ icon: 'success', title: 'Guardado correctamente', text: data.message, timer: 1500, showConfirmButton: false })
                .then(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalFormulario'));
                    if (modal) modal.hide();
                    if (typeof cargarDatos === 'function') cargarDatos();
                });
        } else {
            Swal.fire({ icon: 'error', title: 'Error al guardar', text: data.error || 'Ocurri√≥ un error desconocido' });
        }
    })
    .catch(error => {
        Swal.close();
        console.error('Error:', error);
        Swal.fire({ icon: 'error', title: 'Error de conexi√≥n', text: 'No se pudo conectar con el servidor' });
    })
    .finally(() => {
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = originalText;
    });
}

function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}
</script>